---
title: "ptb_gwas"
author: "sq-96"
date: "2021-07-07"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r,echo=FALSE}
enrichment_test <- function(diff_pvalue_file, pip_cutoff, pvalue_cutoff){
  gene_pip <- read.table('./data/large_pipsumgenes.tsv',sep='\t',header=TRUE)
  gene_pip <- gene_pip[c('Symbol','pip_tot')]
  colnames(gene_pip) = c('gene','pip')
  
  diff_p <- read.table(paste('./data/differential_expression/',diff_pvalue_file,'.txt',sep = ''),sep='\t',header=TRUE)
  diff_p <- diff_p[c('gene','padj')]
  
  pip_p <- merge(gene_pip,diff_p,by='gene')
  pip_p[is.na(pip_p)] = 1
  pip_p <- pip_p[order(pip_p$pip,decreasing = TRUE),]
  
  high_sig <- sum((pip_p$pip>pip_cutoff) & (pip_p$padj<pvalue_cutoff))
  high_nosig <- sum((pip_p$pip>pip_cutoff) & (pip_p$padj>=pvalue_cutoff))
  nohigh_sig <- sum((pip_p$pip<=pip_cutoff) & (pip_p$padj<pvalue_cutoff))
  nohigh_nosig <- sum((pip_p$pip<=pip_cutoff) & (pip_p$padj>=pvalue_cutoff))
  
  sig_high_frac <- high_sig/(high_sig+high_nosig)
  sig_nohigh_frac <- nohigh_sig/(nohigh_sig+nohigh_nosig)
  
  ct <- matrix(c(high_sig,nohigh_sig,high_nosig,nohigh_nosig), ncol=2)
  result<-fisher.test(ct)
  return(c(diff_pvalue_file,round(result$estimate,3),result$p.value,round(result$conf.int[1],3),round(result$conf.int[2],3),sig_high_frac,sig_nohigh_frac))
}
```

## Enrichment test with pip cutoff = 0.3 and p-value cutoff = 0.1
```{r,echo=FALSE}
output_table <- data.frame()

pip_cutoff <- 0.3
pvalue_cutoff <- 0.1

output_table[1,1:5] <- enrichment_test('dec.PLXtcm.PL',pip_cutoff,pvalue_cutoff)[1:5]
output_table[2,1:5] <- enrichment_test('unt.PLXdec.PL',pip_cutoff,pvalue_cutoff)[1:5]
output_table[3,1:5] <- enrichment_test('unt.TLXdec.TL',pip_cutoff,pvalue_cutoff)[1:5]
output_table[4,1:5] <- enrichment_test('dec.TLXtcm.TL',pip_cutoff,pvalue_cutoff)[1:5]
output_table[5,1:5] <- enrichment_test('dec.PLXdec.TL',pip_cutoff,pvalue_cutoff)[1:5]
output_table[6,1:5] <- enrichment_test('unt.PLXctr.TL',pip_cutoff,pvalue_cutoff)[1:5]
# output_table[7,1:5] <- enrichment_test('tcm.PLXtcm.TL',pip_cutoff,pvalue_cutoff)[1:

colnames(output_table) = c('comparison','estimate','p.value','conf.low','conf.high')
output_table[order(output_table$estimate),]
```

```{r,message=FALSE,echo=FALSE,message=FALSE, warning=FALSE}
library(metaseqR)
enrichment_test_combined <- function(diff_pvalue_file1, diff_pvalue_file2, pip_cutoff, pvalue_cutoff){
  gene_pip <- read.table('./data/large_pipsumgenes.tsv',sep='\t',header=TRUE)
  gene_pip <- gene_pip[c('Symbol','pip_tot')]
  colnames(gene_pip) = c('gene','pip')
  
  diff_p_1 <- read.table(paste('./data/differential_expression/',diff_pvalue_file1,'.txt',sep = ''),sep='\t',header=TRUE)
  diff_p_1 <- diff_p_1[c('gene','padj')]
  
  diff_p_2 <- read.table(paste('./data/differential_expression/',diff_pvalue_file2,'.txt',sep = ''),sep='\t',header=TRUE)
  diff_p_2 <- diff_p_2[c('gene','padj')]
  
  diff_p <- cbind(diff_p_1$padj,diff_p_2$padj)
  diff_p <- fisher.method(diff_p,p.corr = "none")$p.adj
  diff_p <- data.frame(gene=as.character(diff_p_1$gene),padj=diff_p)
  
  pip_p <- merge(gene_pip,diff_p,by='gene')
  pip_p[is.na(pip_p)] = 1
  pip_p <- pip_p[order(pip_p$pip,decreasing = ),]
  
  high_sig <- sum((pip_p$pip>pip_cutoff) & (pip_p$padj<pvalue_cutoff))
  high_nosig <- sum((pip_p$pip>pip_cutoff) & (pip_p$padj>=pvalue_cutoff))
  nohigh_sig <- sum((pip_p$pip<=pip_cutoff) & (pip_p$padj<pvalue_cutoff))
  nohigh_nosig <- sum((pip_p$pip<=pip_cutoff) & (pip_p$padj>=pvalue_cutoff))
  
  sig_high_frac <- high_sig/(high_sig+high_nosig)
  sig_nohigh_frac <- nohigh_sig/(nohigh_sig+nohigh_nosig)
  
  ct <- matrix(c(high_sig,nohigh_sig,high_nosig,nohigh_nosig), ncol=2)
  result<-fisher.test(ct)
  return(c(paste(diff_pvalue_file1,diff_pvalue_file2),round(result$estimate,3),result$p.value,round(result$conf.int[1],3),round(result$conf.int[2],3),sig_high_frac,sig_nohigh_frac))
}
  
```

```{r,echo=FALSE}
dec.PL_unt.PL <- as.numeric(enrichment_test('unt.PLXdec.PL',pip_cutoff,pvalue_cutoff)[6:7])
dec.TL_unt.TL <- as.numeric(enrichment_test('unt.TLXdec.TL',pip_cutoff,pvalue_cutoff)[6:7])
dec.PL_tcm.PL <- as.numeric(enrichment_test('dec.PLXtcm.PL',pip_cutoff,pvalue_cutoff)[6:7])
dec.TL_tcm.TL <- as.numeric(enrichment_test('dec.TLXtcm.TL',pip_cutoff,pvalue_cutoff)[6:7])
#dec_tcm <- as.numeric(enrichment_test_combined('dec.PLXtcm.PL','dec.TLXtcm.TL',pip_cutoff,pvalue_cutoff)[6:7])
#ctr_dec <- as.numeric(enrichment_test_combined('unt.PLXdec.PL','unt.TLXdec.TL',pip_cutoff,pvalue_cutoff)[6:7])

df <- data.frame(group = rep(c("high pip", "low pip"),each=4),
                 comparison = rep(c("dec.PL_unt.PL","dec.TL_unt.TL","dec.PL_tcm.PL","dec.TL_tcm.TL"),2),
                 fraction = c(dec.PL_unt.PL[1],dec.TL_unt.TL[1],dec.PL_tcm.PL[1],dec.TL_tcm.TL[1],
                              dec.PL_unt.PL[2],dec.TL_unt.TL[2],dec.PL_tcm.PL[2],dec.TL_tcm.TL[2]))

df$comparison <- factor(df$comparison, levels = c("dec.PL_unt.PL","dec.TL_unt.TL","dec.PL_tcm.PL","dec.TL_tcm.TL"))
```

## Percent of DEGs in high PIP vs. low PIP genes
```{r,echo=FALSE,message=FALSE}
library(ggplot2)
p <- ggplot(data=df, aes(x=comparison, y=fraction, fill=group)) +
geom_bar(stat="identity", color="black", position=position_dodge())+theme_minimal()
p + scale_fill_brewer(palette="Blues")
```

```{r,echo=FALSE}
make_bubble_plot <- function(diff_pvalue_file, pip_cutoff, pvalue_cutoff){
  gene_pip <- read.table('./data/large_pipsumgenes.tsv',sep='\t',header=TRUE)
  gene_pip <- gene_pip[c('Symbol','pip_tot')]
  colnames(gene_pip) = c('gene','pip')
  
  diff_p <- read.table(paste('./data/differential_expression/',diff_pvalue_file,'.txt',sep = ''),sep='\t',header=TRUE)
  diff_p <- diff_p[c('gene','padj')]
  
  pip_p <- merge(gene_pip,diff_p,by='gene')
  pip_p[is.na(pip_p)] = 1
  pip_p <- pip_p[order(pip_p$pip,decreasing = TRUE),]
  pip_p$gene <- as.character(pip_p$gene)
  
  pip_p <- pip_p[pip_p$pip>0.3,]
  pip_p$padj <- -log10(pip_p$padj)
  #ggplot(pip_p, aes(x=pip,y=gene,size=padj))+geom_point(alpha=0.7)+labs(title = diff_pvalue_file)+theme(axis.text=element_text(size=16),axis.title=element_text(size=20),plot.title=element_text(size=20,hjust = 0.5))
  return(pip_p)
}
```

## DEG and PIP statistics of candidate genes (PIP > 0.3)
```{r,echo=FALSE,message=FALSE}
library(plot.matrix)
library(RColorBrewer)
df1 <- make_bubble_plot('dec.PLXdec.TL',pip_cutoff,pvalue_cutoff)
df2 <- make_bubble_plot('dec.PLXtcm.PL',pip_cutoff,pvalue_cutoff)
df3 <- make_bubble_plot('dec.TLXtcm.TL',pip_cutoff,pvalue_cutoff)
df4 <- make_bubble_plot('tcm.PLXtcm.TL',pip_cutoff,pvalue_cutoff)
df5 <- make_bubble_plot('unt.PLXctr.TL',pip_cutoff,pvalue_cutoff)
df6 <- make_bubble_plot('unt.PLXdec.PL',pip_cutoff,pvalue_cutoff)
df7 <- make_bubble_plot('unt.TLXdec.TL',pip_cutoff,pvalue_cutoff)
#df_heatmap <- cbind(df1$padj,df2$padj,df3$padj,df4$padj,df5$padj,df6$padj,df7$padj)
#rownames(df_heatmap) <- df1$gene
#colnames(df_heatmap) <- c("dec.PL_dec.TL","dec.PL_tcm.PL","dec.TL_tcm.TL","tcm.PL_tcm.TL","unt.PL_ctr.TL","unt.PL_dec.PL","unt.TL_dec.TL")
```

```{r,fig.height=10, fig.width=15}
#par(mar=c(5.1, 4.1, 4.1, 4.1))
#layout(mat = matrix(c(1, 2), nrow = 1),widths = c(1, 0.4),heights = c(1,0.5))
#p1 <- plot(as.matrix(df_heatmap),axis.col=list(las=1, cex.axis=1), axis.row=list(las=2, cex.axis=1),xlab="", ylab="", main="-log10(p-value)",col=brewer.pal(8,name = "Reds"),spacing.key=c(1,0.5,0))
#p2 <- plot(as.matrix(df1$pip),digits=3,key=NULL,col='white',axis.col=NULL, axis.row=NULL,xlab="", ylab="",main="PIP")
#p2 <- barplot(df1$pip[order(df1$pip,decreasing = TRUE)],horiz=TRUE)
```

```{r}
df1["group"] <- "dec.PL_dec.TL"
df2["group"] <- "dec.PL_tcm.PL"
df3["group"] <- "dec.TL_tcm.TL"
df4["group"] <- "tcm.PL_tcm.TL"
df5["group"] <- "unt.PL_ctr.TL"
df6["group"] <- "unt.PL_dec.PL"
df7["group"] <- "unt.TL_dec.TL"
df_heatmap <- rbind(df1,df2,df3,df4,df5,df6,df7)
df_heatmap$gene <- factor(df_heatmap$gene, levels = df1$gene)
df1$gene <- factor(df1$gene, levels = df1$gene)
df_heatmap$padj[which(df_heatmap$padj>6)]=6
```

```{r}
library(gridExtra)
library(grid)
library(lattice)
p1 <- ggplot(data=df_heatmap,aes(x=group,y=gene,fill=padj))+geom_tile()+theme(panel.background = element_blank(),axis.ticks.y = element_blank(),axis.ticks.x = element_blank(),legend.position="left")+scale_fill_distiller(palette = "Blues",direction = 2,name='q-value')+labs(title="",x ="", y = "")+guides(fill = guide_legend(label.position = "right", label.hjust = 1))

p2 <- ggplot(data=df1, aes(x=gene, y=pip)) +
geom_bar(stat="identity", color="#fb9a99", position=position_dodge(),fill='#fb9a99')+coord_flip()+theme(panel.background = element_blank(),axis.text.y = element_blank(),axis.ticks.y = element_blank(), axis.line.x = element_line(),axis.title.y = element_blank())

grid.arrange(p1,p2,ncol=2,nrow=1,widths=c(0.8, 0.2))
```

